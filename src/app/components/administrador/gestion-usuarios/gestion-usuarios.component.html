<!-- src/app/components/gestion-usuarios/gestion-usuarios.component.html -->
<div class="crud-container">
    <aside class="sidebar">
        <div class="logo">
            <img src="assets/icon/logo.jpg" alt="Logo" />
        </div>
        <nav>
            <ul>
                <li><a (click)="irAPagina('inicio')">üè† Inicio</a></li>
                <li><a (click)="irAPagina('locales')">üìç Locales</a></li>
                <li><a (click)="irAPagina('socios')">üßë‚Äçü§ù‚Äçüßë Socios</a></li>
                <li><a (click)="irAPagina('oferta')">üè∑ Ofertas</a></li>
                <li><a (click)="irAPagina('plano_contenedores')">üöõ Contenedores</a></li>
                <li><a (click)="irAPagina('producto')">üì¶ Productos</a></li>
                <li><a (click)="irAPagina('usuarios')" class="active">üë§ Usuarios</a></li>
            </ul>
        </nav>
        <nav class="bottom-nav">
            <ul>
                <li><a href="#config">‚öôÔ∏è Configuraci√≥n</a></li>
            </ul>
        </nav>
    </aside>

    <main class="content-area">
        <!-- Formulario de Creaci√≥n/Edici√≥n de Usuario -->
        <div class="form-card">
            <h2>{{ isEditMode ? 'Editar Usuario' : 'Crear Nuevo Usuario' }}</h2>

            <form [formGroup]="userForm" (ngSubmit)="saveUser()">

                <!-- Mensajes de estado -->
                <div *ngIf="errorMessage" class="message error-message">
                    {{ errorMessage }}
                </div>
                <div *ngIf="successMessage" class="message success-message">
                    {{ successMessage }}
                </div>

                <!-- Spinner de carga -->
                <div *ngIf="isLoading" class="loading-spinner">
                    <div class="loader"></div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="username">Nombre de Usuario</label>
                        <input id="username" type="text" formControlName="username" placeholder="Escribe el nombre de usuario">
                        <div *ngIf="userForm.get('username')?.invalid && (userForm.get('username')?.dirty || userForm.get('username')?.touched)" class="validation-message">
                            <span *ngIf="userForm.get('username')?.errors?.['required']">El nombre de usuario es obligatorio.</span>
                            <span *ngIf="userForm.get('username')?.errors?.['minlength']">M√≠nimo 4 caracteres.</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="role">Rol</label>
                        <select id="role" formControlName="role">
                            <option value="local_owner">Due√±o de Local</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>

                    <div class="form-group" *ngIf="userForm.get('role')?.value === 'local_owner'">
                        <label for="local">Asignar a Local</label>
                        <select id="local" formControlName="id_local">
                            <option [ngValue]="null" disabled>Selecciona un local</option>
                            <option *ngFor="let local of locales" [ngValue]="local.id_local">
                                {{ local.nombre_del_negocio }} ({{ local.codigo_local }})
                            </option>
                        </select>
                        <div *ngIf="userForm.get('id_local')?.invalid && (userForm.get('id_local')?.dirty || userForm.get('id_local')?.touched)" class="validation-message">
                            <span>Debes seleccionar un local para el due√±o.</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="password">Contrase√±a</label>
                        <input id="password" type="password" formControlName="password" placeholder="Escribe la contrase√±a">
                        <div *ngIf="userForm.get('password')?.invalid && (userForm.get('password')?.dirty || userForm.get('password')?.touched)" class="validation-message">
                            <span *ngIf="userForm.get('password')?.errors?.['required']">La contrase√±a es obligatoria.</span>
                            <span *ngIf="userForm.get('password')?.errors?.['minlength']">M√≠nimo 6 caracteres.</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">Confirmar Contrase√±a</label>
                        <input id="confirmPassword" type="password" formControlName="confirmPassword" placeholder="Confirma la contrase√±a">
                        <div *ngIf="userForm.get('confirmPassword')?.invalid && (userForm.get('confirmPassword')?.dirty || userForm.get('confirmPassword')?.touched)" class="validation-message">
                            <span *ngIf="userForm.get('confirmPassword')?.errors?.['required']">La confirmaci√≥n es obligatoria.</span>
                        </div>
                        <div *ngIf="userForm.get('password')?.value !== userForm.get('confirmPassword')?.value && userForm.get('confirmPassword')?.dirty" class="validation-message">
                            <span>Las contrase√±as no coinciden.</span>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" [disabled]="userForm.invalid || isLoading">
                        {{ isEditMode ? 'Actualizar Usuario' : 'Crear Usuario' }}
                    </button>
                    <button *ngIf="isEditMode" type="button" class="cancel-button" (click)="cancelEdit()">Cancelar</button>
                </div>
            </form>
        </div>

        <!-- Tabla de Usuarios -->
        <div class="table-card">
            <h2>Lista de Usuarios</h2>
            <div *ngIf="users.length === 0 && !isLoading" class="no-content-message">
                No se encontraron usuarios.
            </div>
            <div *ngIf="isLoading" class="loading-spinner-table">
                <div class="loader"></div>
            </div>
            <table *ngIf="users.length > 0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre de Usuario</th>
                        <th>Rol</th>
                        <th>Local Asignado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let user of users">
                        <td>{{ user.id_user }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.role }}</td>
                        <td>{{ getLocalName(user.id_local) }}</td>
                        <td class="action-buttons">
                            <button class="edit-button" (click)="editUser(user)">Editar</button>
                            <button class="delete-button" (click)="deleteUser(user.id_user)">Eliminar</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
</div>
